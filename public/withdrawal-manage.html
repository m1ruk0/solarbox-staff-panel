<!DOCTYPE html>
<html lang="ru" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–æ–º - SolarBox Staff Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="sidebar"></div>

    <div class="container">
        <div class="header-card">
            <h1 class="page-title">
                <i class="fas fa-tasks mr-3"></i>
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–æ–º —Å–æ–ª—è—Ä–∏–∫–æ–≤
            </h1>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid mb-6">
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
                    <div class="stat-value" id="totalWithdrawals">0</div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-file-invoice"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-label">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
                    <div class="stat-value" id="pendingWithdrawals">0</div>
                </div>
                <div class="stat-icon stat-icon-yellow">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
                    <div class="stat-value" id="approvedWithdrawals">0</div>
                </div>
                <div class="stat-icon stat-icon-green">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
                    <div class="stat-value" id="rejectedWithdrawals">0</div>
                </div>
                <div class="stat-icon stat-icon-red">
                    <i class="fas fa-times-circle"></i>
                </div>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="glass-card mb-6">
            <div class="filter-tabs">
                <div class="filter-tab active">
                    <i class="fas fa-list mr-2"></i>–í—Å–µ
                </div>
                <div class="filter-tab">
                    <i class="fas fa-clock mr-2"></i>–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                </div>
                <div class="filter-tab">
                    <i class="fas fa-check-circle mr-2"></i>–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ
                </div>
                <div class="filter-tab">
                    <i class="fas fa-times-circle mr-2"></i>–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
        <div id="withdrawalsContainer"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è -->
    <div id="approveModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-white mb-4">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                –û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É
            </h3>
            <p class="text-gray-400 mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?</p>
            <div class="flex gap-3">
                <button onclick="confirmApprove()" class="btn btn-primary flex-1">
                    <i class="fas fa-check mr-2"></i>–û–¥–æ–±—Ä–∏—Ç—å
                </button>
                <button onclick="closeModal('approveModal')" class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>–û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-white mb-4">
                <i class="fas fa-times-circle text-red-500 mr-2"></i>
                –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
            </h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-400 mb-2">
                    –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                </label>
                <textarea id="rejectComment" class="input-field" rows="3" 
                    placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è..."></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="confirmReject()" class="btn btn-danger flex-1">
                    <i class="fas fa-times mr-2"></i>–û—Ç–∫–ª–æ–Ω–∏—Ç—å
                </button>
                <button onclick="closeModal('rejectModal')" class="btn btn-secondary">
                    <i class="fas fa-ban mr-2"></i>–û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script src="sidebar.js"></script>
    <script src="app.js"></script>
    <script>
        let allWithdrawals = [];
        let currentFilter = 'all';
        let currentWithdrawalId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            checkAuth();
            await loadWithdrawals();
            initializeFilters();
        });

        function initializeFilters() {
            const filterTabs = document.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const filter = this.textContent.includes('–í—Å–µ') ? 'all' :
                                   this.textContent.includes('—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏') ? 'pending' :
                                   this.textContent.includes('–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ') ? 'approved' : 'rejected';
                    filterWithdrawals(filter, this);
                });
            });
        }

        function checkAuth() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(userStr);
        }

        async function loadWithdrawals() {
            try {
                const response = await fetch(`${API_URL}/withdrawals`);
                const data = await response.json();
                
                if (data.success) {
                    allWithdrawals = data.data;
                    updateStats();
                    displayWithdrawals();
                } else {
                    showToast(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        function updateStats() {
            document.getElementById('totalWithdrawals').textContent = allWithdrawals.length;
            document.getElementById('pendingWithdrawals').textContent = allWithdrawals.filter(w => w.status === 'pending').length;
            document.getElementById('approvedWithdrawals').textContent = allWithdrawals.filter(w => w.status === 'approved').length;
            document.getElementById('rejectedWithdrawals').textContent = allWithdrawals.filter(w => w.status === 'rejected').length;
        }

        function filterWithdrawals(filter, element) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (element) {
                element.classList.add('active');
            }
            
            displayWithdrawals();
        }

        function displayWithdrawals() {
            const container = document.getElementById('withdrawalsContainer');
            
            let filtered = allWithdrawals;
            if (currentFilter !== 'all') {
                filtered = allWithdrawals.filter(w => w.status === currentFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="glass-card">
                        <p class="text-gray-400 text-center py-8">–ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map((w, index) => `
                <div class="glass-card mb-4">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${getStatusIcon(w.status)}</span>
                            <div>
                                <h3 class="text-xl font-bold text-white">${w.discord}</h3>
                                <p class="text-gray-400">
                                    <i class="fas fa-gamepad mr-2"></i>${w.minecraft}
                                </p>
                            </div>
                        </div>
                        ${getStatusBadge(w.status)}
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-2xl font-bold text-yellow-400">
                            <i class="fas fa-coins mr-2"></i>${w.amount} —Å–æ–ª—è—Ä–∏–∫–æ–≤
                        </p>
                    </div>
                    
                    ${w.status === 'pending' ? `
                        <div class="flex gap-3 mt-4">
                            <button onclick="openApproveModal('${w.id}')" class="btn btn-primary flex-1">
                                <i class="fas fa-check mr-2"></i>–û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button onclick="openRejectModal('${w.id}')" class="btn btn-danger flex-1">
                                <i class="fas fa-times mr-2"></i>–û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    ` : ''}
                    
                    ${w.reviewer ? `
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <p class="text-sm text-gray-400">
                                <i class="fas fa-user-check mr-2"></i>
                                <strong>–ü—Ä–æ–≤–µ—Ä–∏–ª:</strong> ${w.reviewer}
                            </p>
                            ${w.comment ? `
                                <p class="text-sm text-gray-400 mt-2">
                                    <i class="fas fa-comment mr-2"></i>
                                    <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${w.comment}
                                </p>
                            ` : ''}
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="far fa-clock mr-1"></i>${new Date(w.reviewed_at).toLocaleString('ru-RU')}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="mt-4 text-xs text-gray-500">
                        <i class="fas fa-hashtag mr-1"></i>–ó–∞—è–≤–∫–∞ ‚Ññ${index + 1} ‚Ä¢ 
                        <i class="far fa-calendar mr-1"></i>${new Date(w.created_at).toLocaleString('ru-RU')}
                    </div>
                </div>
            `).join('');
        }

        function getStatusIcon(status) {
            const icons = {
                'pending': '‚è≥',
                'approved': '‚úÖ',
                'rejected': '‚ùå'
            };
            return icons[status] || 'üìã';
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="px-4 py-2 bg-yellow-500 bg-opacity-20 text-yellow-400 rounded-full font-medium"><i class="fas fa-clock mr-2"></i>–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>',
                'approved': '<span class="px-4 py-2 bg-green-500 bg-opacity-20 text-green-400 rounded-full font-medium"><i class="fas fa-check-circle mr-2"></i>–û–¥–æ–±—Ä–µ–Ω–æ</span>',
                'rejected': '<span class="px-4 py-2 bg-red-500 bg-opacity-20 text-red-400 rounded-full font-medium"><i class="fas fa-times-circle mr-2"></i>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>'
            };
            return badges[status] || '';
        }

        function openApproveModal(id) {
            currentWithdrawalId = id;
            document.getElementById('approveModal').classList.add('active');
        }

        function openRejectModal(id) {
            currentWithdrawalId = id;
            document.getElementById('rejectComment').value = '';
            document.getElementById('rejectModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            currentWithdrawalId = null;
        }

        async function confirmApprove() {
            try {
                const response = await fetch(`${API_URL}/withdrawals/${currentWithdrawalId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reviewer: currentUser.discord
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!', 'success');
                    closeModal('approveModal');
                    await loadWithdrawals();
                } else {
                    showToast(data.error || '–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        async function confirmReject() {
            const comment = document.getElementById('rejectComment').value.trim();
            
            if (!comment) {
                showToast('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/withdrawals/${currentWithdrawalId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reviewer: currentUser.discord,
                        comment
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'info');
                    closeModal('rejectModal');
                    await loadWithdrawals();
                } else {
                    showToast(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800'} text-white border ${type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-gray-600'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
    </script>
</body>
</html>
